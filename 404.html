<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#4f46e5" />
    <link rel="apple-touch-icon" href="/icons/icon-512x512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>해보자! 행운부르기</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Square+Neo:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Metrics API base is set by index.tsx via import.meta.env.VITE_METRICS_API_BASE -->
    <style>
      body {
        font-family: 'Nanum Square Neo', sans-serif;
        background-color: #f8fafc; /* Fallback */
        background-image: linear-gradient(to top, #fff1eb 0%, #e0f2fe 100%);
      }
      @keyframes marquee {
        from { transform: translateX(0); }
        to { transform: translateX(-50%); }
      }
      .animate-marquee {
        animation: marquee 40s linear infinite;
      }
    </style>

  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.20.0"
  }
}
</script>
  <script type="module" crossorigin src="/assets/index-DGtyuLYs.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/index-D0g6LghM.css">
</head>
  <body>
    <div id="root"></div>
  <!-- ✅ PWA 설치 및 Safari 안내 배너 -->
<style>
  #pwaInstallBanner {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(30, 30, 30, 0.95);
    color: #fff;
    padding: 14px 18px;
    font-size: 15px;
    z-index: 9999;
    text-align: center;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
  }
  #pwaInstallBanner button {
    background: #007aff;
    border: none;
    color: white;
    padding: 8px 14px;
    border-radius: 8px;
    margin-left: 8px;
    font-size: 14px;
  }
</style>

<div id="pwaInstallBanner">
  <!-- 내용은 자바스크립트에서 동적으로 변경됩니다 -->
</div>

<script>
(function() {
  const banner = document.getElementById('pwaInstallBanner');
  const ua = navigator.userAgent;
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isAndroid = /Android/i.test(ua);
  const isInAppBrowser = /(KAKAOTALK|NAVER|FBAN|FBAV|Instagram|Line)/i.test(ua);

  // 이미 설치(standalone) 상태면 배너를 표시하지 않음
  const isStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
  if (isStandalone) return;

  // ✅ PWA 설치 이벤트 감지 (안드로이드 전용)
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // iOS가 아니면 PWA 설치 배너 표시
    if (!isIOS && !isInAppBrowser) {
      banner.innerHTML = `
        📱 앱처럼 사용하시겠어요?
        <button id="installBtn">홈화면에 추가</button>
      `;
      banner.style.display = 'block';

      document.getElementById('installBtn').addEventListener('click', async () => {
        banner.style.display = 'none';
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        if (choice.outcome === 'accepted') {
          console.log('사용자가 PWA 설치를 수락함');
        }
      });
    }
  });

  // 설치 완료되면 배너 숨김
  window.addEventListener('appinstalled', () => {
    banner.style.display = 'none';
    // 총 설치수 카운트(안드로이드 등 appinstalled 지원)
    try { window.MAKE_LUCKY && window.MAKE_LUCKY.hitInstallOnce(); } catch (e) {}
  });

  // ✅ iOS + 인앱브라우저 (카카오톡 등)일 때 Safari 안내 표시
  if (isIOS && isInAppBrowser) {
    banner.innerHTML = `
      📌 홈화면 설치를 위해 Safari에서 열어주세요.
      <button id="openSafariBtn">Safari로 열기</button>
      <span style="display:block; margin-top:6px; font-size:13px; opacity:0.85;">
        만약 Safari가 열리지 않으면, 화면 하단/오른쪽의 <strong>공유하기</strong> 버튼(⬆️)을 누르고
        <strong>“Safari에서 열기”</strong> 또는 <strong>“브라우저에서 열기”</strong>를 선택하세요.
      </span>
    `;
    banner.style.display = 'block';

    document.getElementById('openSafariBtn').addEventListener('click', async () => {
      const currentUrl = window.location.href;
      // 1) 새 창으로 열기 시도 (일부 인앱브라우저는 이 후 'Safari에서 열기' 옵션 노출)
      let opened = null;
      try {
        opened = window.open(currentUrl, '_blank', 'noopener,noreferrer');
      } catch (_) { /* ignore */ }

      // 2) 주소 복사 시도 (사용자 보조)
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(currentUrl);
        }
      } catch (_) { /* ignore */ }

      // 3) 안내 메시지 (실패 대비 가이드)
      setTimeout(() => {
        if (!opened || opened.closed) {
          alert(
            'Safari로 자동으로 열리지 않았다면,\n' +
            '화면 하단/오른쪽의 공유하기(⬆️) 버튼을 눌러\n' +
            '“Safari에서 열기” 또는 “브라우저에서 열기”를 선택해 주세요.\n\n' +
            '주소가 복사되었다면 Safari에서 붙여넣어 접속할 수 있어요:\n' + currentUrl
          );
        }
      }, 1200);
    });
  }

  // ✅ iOS Safari에서는 설치 안내 (Add to Home Screen)
  if (isIOS && !isInAppBrowser) {
    banner.innerHTML = `
      📲 홈화면에 앱처럼 추가하려면,
      하단의 <strong>공유 아이콘(⬆️)</strong>을 누른 뒤
      <strong>“홈 화면에 추가”</strong>를 선택하세요.
    `;
    banner.style.display = 'block';
    setTimeout(() => banner.style.display = 'none', 20000);
  }

})();
</script>

<!-- ✅ Service Worker 등록 (PWA installability 보장) -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      // 상대 경로로 등록: /MakeLucky/ 및 루트 모두에서 정상 동작
      navigator.serviceWorker.register('./sw.js').catch((err) => {
        console.warn('Service Worker registration failed', err);
      });
    });
  }

  // ✅ iOS 등 appinstalled 이벤트가 없는 환경: 독립실행(standalone) 첫 실행 시 설치수 증가
  (function() {
    try {
      const isStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
      if (isStandalone) {
        try { window.MAKE_LUCKY && window.MAKE_LUCKY.hitInstallOnce(); } catch (e) {}
      }
    } catch (e) { /* ignore */ }
  })();
  </script>

  </body>
</html>